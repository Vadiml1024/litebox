name: Test Win32 Programs on Linux

permissions:
  contents: read

on:
  push:
    branches:
      - main
    paths:
      - 'windows_test_programs/winsock_test/**'
      - 'windows_test_programs/registry_test/**'
      - 'litebox_platform_linux_for_windows/**'
      - 'litebox_shim_windows/**'
      - 'litebox_runner_windows_on_linux_userland/**'
      - '.github/workflows/test-win32-tests-on-linux.yml'
  pull_request:
    paths:
      - 'windows_test_programs/winsock_test/**'
      - 'windows_test_programs/registry_test/**'
      - 'litebox_platform_linux_for_windows/**'
      - 'litebox_shim_windows/**'
      - 'litebox_runner_windows_on_linux_userland/**'
      - '.github/workflows/test-win32-tests-on-linux.yml'
  merge_group:
  workflow_dispatch:

# Cancel in-progress runs for the same ref so duplicate pushes don't pile up.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: -Dwarnings

jobs:
  test_win32:
    name: Build and Run ${{ matrix.suite }} Tests on Linux
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - suite: winsock
            test_dir: windows_test_programs/winsock_test
          - suite: registry
            test_dir: windows_test_programs/registry_test

    steps:
      # ── Checkout ──────────────────────────────────────────────────────────
      - name: Check out repo
        uses: actions/checkout@v4

      # ── Toolchain ─────────────────────────────────────────────────────────
      - name: Set up Rust
        run: |
          rustup toolchain install \
            $(awk -F'"' '/channel/{print $2}' rust-toolchain.toml) \
            --profile minimal \
            --no-self-update \
            --target x86_64-unknown-linux-gnu

      # ── MinGW cross-compiler ───────────────────────────────────────────────
      - name: Install MinGW cross-compiler
        run: |
          sudo apt-get update -y
          sudo apt-get install -y mingw-w64

      # ── Cargo cache (shared key so both matrix jobs can reuse runner build) ─
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: wol-runner

      # ── Build the test programs for this suite ────────────────────────────
      - name: Build ${{ matrix.suite }} test programs
        run: |
          make -C ${{ matrix.test_dir }}
          echo "Built executables:"
          ls -lh ${{ matrix.test_dir }}/*.exe
          file ${{ matrix.test_dir }}/*.exe

      # ── Build the Windows-on-Linux runner ─────────────────────────────────
      - name: Build Windows-on-Linux runner
        run: cargo build --locked -p litebox_runner_windows_on_linux_userland

      # ── Winsock-specific test steps ───────────────────────────────────────
      - name: Run winsock_basic_test
        if: matrix.suite == 'winsock'
        run: |
          echo "=== winsock_basic_test.exe ==="
          ./target/debug/litebox_runner_windows_on_linux_userland \
            windows_test_programs/winsock_test/winsock_basic_test.exe \
            2>&1 | tee /tmp/winsock_basic_out.txt

          echo ""
          echo "--- Verifying test output ---"
          grep -q "WinSock Basic API Tests PASSED" /tmp/winsock_basic_out.txt \
            || { echo "✗ winsock_basic_test FAILED"; exit 1; }
          echo "✓ winsock_basic_test PASSED"

      - name: Run winsock_tcp_test
        if: matrix.suite == 'winsock'
        run: |
          echo "=== winsock_tcp_test.exe ==="
          ./target/debug/litebox_runner_windows_on_linux_userland \
            windows_test_programs/winsock_test/winsock_tcp_test.exe \
            2>&1 | tee /tmp/winsock_tcp_out.txt

          echo ""
          echo "--- Verifying test output ---"
          grep -q "WinSock TCP Socket Tests PASSED" /tmp/winsock_tcp_out.txt \
            || { echo "✗ winsock_tcp_test FAILED"; exit 1; }
          echo "✓ winsock_tcp_test PASSED"

      - name: Run winsock_udp_test
        if: matrix.suite == 'winsock'
        run: |
          echo "=== winsock_udp_test.exe ==="
          ./target/debug/litebox_runner_windows_on_linux_userland \
            windows_test_programs/winsock_test/winsock_udp_test.exe \
            2>&1 | tee /tmp/winsock_udp_out.txt

          echo ""
          echo "--- Verifying test output ---"
          grep -q "WinSock UDP Socket Tests PASSED" /tmp/winsock_udp_out.txt \
            || { echo "✗ winsock_udp_test FAILED"; exit 1; }
          echo "✓ winsock_udp_test PASSED"

      # ── Registry-specific test steps ──────────────────────────────────────
      - name: Run registry_test
        if: matrix.suite == 'registry'
        run: |
          echo "=== registry_test.exe ==="
          ./target/debug/litebox_runner_windows_on_linux_userland \
            windows_test_programs/registry_test/registry_test.exe \
            2>&1 | tee /tmp/registry_test_out.txt

          echo ""
          echo "--- Verifying test output ---"
          grep -q "Windows Registry API Tests PASSED" /tmp/registry_test_out.txt \
            || { echo "✗ registry_test FAILED"; exit 1; }
          echo "✓ registry_test PASSED"

      # ── Upload test output on failure ─────────────────────────────────────
      - name: Upload test output on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.suite }}-test-output
          path: /tmp/${{ matrix.suite }}_*.txt
          retention-days: 7

      # ── Summary ───────────────────────────────────────────────────────────
      - name: Summary
        if: always()
        run: |
          echo ""
          echo "================================================"
          echo " ${{ matrix.suite }} Tests on Linux – Summary"
          echo "================================================"
          for f in /tmp/${{ matrix.suite }}_*.txt; do
            [ -f "$f" ] || continue
            name=$(basename "$f" _out.txt)
            pass=$(grep -c "\[PASS\]" "$f" || true)
            fail=$(grep -c "\[FAIL\]" "$f" || true)
            if grep -qE "PASSED \(0 failures\)|Tests PASSED" "$f"; then
              echo "  ✓ ${name}: ${pass} passed, ${fail} failed"
            else
              echo "  ✗ ${name}: ${pass} passed, ${fail} failed"
            fi
          done
          echo "================================================"
