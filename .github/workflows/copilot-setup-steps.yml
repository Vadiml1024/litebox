name: "Copilot Setup Steps"

on:
  workflow_dispatch:

jobs:
  copilot-setup-steps:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install the fast mold linker (3-5x faster linking per your own docs)
      - name: Install mold linker
        run: sudo apt-get update && sudo apt-get install -y mold clang

      # Cache Cargo registry, git sources, and compiled deps
      - name: Cache Cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          # Cache key includes Cargo.lock so it busts when deps change
          key: litebox-cargo-${{ hashFiles('**/Cargo.lock') }}

      # Pre-fetch and compile all dependencies (the biggest time saver)
      # Uses --workspace so all crate deps are warmed up at once
      - name: Pre-fetch Cargo dependencies
        run: cargo fetch

      # Pre-build dependencies in check mode to warm up the cache
      - name: Pre-build workspace dependencies
        run: |
          cargo check --workspace \
            --exclude litebox_runner_lvbs \
            --exclude litebox_runner_snp

      # Install cargo-nextest for faster test execution (2-3x speedup per your docs)
      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest

      # Install Node.js (needed for MCP servers and dev_bench node benchmarks)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
