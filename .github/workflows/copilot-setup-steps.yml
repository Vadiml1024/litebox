name: "Copilot Setup Steps"

on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  copilot-setup-steps:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust
        run: |
          rustup toolchain install $(awk -F'"' '/channel/{print $2}' rust-toolchain.toml) --profile minimal --no-self-update --component rustfmt,clippy --target x86_64-unknown-linux-gnu --target x86_64-pc-windows-gnu

      - name: Set up Nextest
        uses: taiki-e/install-action@v2
        with:
          tool: nextest@0.9.114

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Cache custom out directories
        uses: actions/cache@v4
        with:
          path: |
            target/*/build/litebox_runner_linux_userland-*/out
          key: copilot-agent-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('**/litebox_syscall_rewriter/**/*.rs') }}

      - name: Install iperf3
        run: sudo apt-get install -y iperf3

      - name: Install gdb
        run: sudo apt-get install -y gdb

      - name: Install MinGW cross-compiler for Windows program development
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64

      - name: Pre-build Windows test programs
        run: |
          cd windows_test_programs
          cargo build --release --target x86_64-pc-windows-gnu 2>/dev/null || true

      - name: Pre-build workspace
        run: cargo build --locked 2>/dev/null || true

      - name: Set up tun device for Linux userland testing
        run: |
          sudo ./litebox_platform_linux_userland/scripts/tun-setup.sh
