name: Test Registry Programs on Linux

permissions:
  contents: read

on:
  push:
    branches:
      - main
    paths:
      - 'windows_test_programs/registry_test/**'
      - 'litebox_platform_linux_for_windows/**'
      - 'litebox_shim_windows/**'
      - 'litebox_runner_windows_on_linux_userland/**'
      - '.github/workflows/test-registry-on-linux.yml'
  pull_request:
    paths:
      - 'windows_test_programs/registry_test/**'
      - 'litebox_platform_linux_for_windows/**'
      - 'litebox_shim_windows/**'
      - 'litebox_runner_windows_on_linux_userland/**'
      - '.github/workflows/test-registry-on-linux.yml'
  merge_group:
  workflow_dispatch:

# Cancel in-progress runs for the same ref so duplicate pushes don't pile up.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: -Dwarnings

jobs:
  test_registry:
    name: Build and Run Registry Tests on Linux
    runs-on: ubuntu-latest

    steps:
      # ── Checkout ──────────────────────────────────────────────────────────
      - name: Check out repo
        uses: actions/checkout@v4

      # ── Rust toolchain ────────────────────────────────────────────────────
      - name: Set up Rust
        run: |
          rustup toolchain install \
            $(awk -F'"' '/channel/{print $2}' rust-toolchain.toml) \
            --profile minimal \
            --no-self-update \
            --target x86_64-unknown-linux-gnu

      # ── MinGW cross-compiler ───────────────────────────────────────────────
      - name: Install MinGW cross-compiler
        run: |
          sudo apt-get update -y
          sudo apt-get install -y mingw-w64

      # ── Cargo cache ───────────────────────────────────────────────────────
      - uses: Swatinem/rust-cache@v2

      # ── Build the registry C++ test program ───────────────────────────────
      - name: Build registry_test.exe
        run: |
          make -C windows_test_programs/registry_test
          echo "Built executables:"
          ls -lh windows_test_programs/registry_test/*.exe
          file windows_test_programs/registry_test/*.exe

      # ── Build the Windows-on-Linux runner ─────────────────────────────────
      - name: Build Windows-on-Linux runner
        run: |
          cargo build --locked -p litebox_runner_windows_on_linux_userland

      # ── Run the registry test program ─────────────────────────────────────
      - name: Run registry_test
        run: |
          echo "=== registry_test.exe ==="
          ./target/debug/litebox_runner_windows_on_linux_userland \
            windows_test_programs/registry_test/registry_test.exe \
            2>&1 | tee /tmp/registry_test_out.txt

          echo ""
          echo "--- Verifying test output ---"
          grep -q "Windows Registry API Tests PASSED" /tmp/registry_test_out.txt \
            || { echo "✗ registry_test FAILED"; exit 1; }
          echo "✓ registry_test PASSED"

      # ── Upload test output on failure ─────────────────────────────────────
      - name: Upload test output on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: registry-test-output
          path: /tmp/registry_test_out.txt
          retention-days: 7

      # ── Summary ───────────────────────────────────────────────────────────
      - name: Summary
        if: always()
        run: |
          echo ""
          echo "================================================"
          echo " Registry Tests on Linux – Summary"
          echo "================================================"
          if [ -f /tmp/registry_test_out.txt ]; then
            pass=$(grep -c "\[PASS\]" /tmp/registry_test_out.txt || true)
            fail=$(grep -c "\[FAIL\]" /tmp/registry_test_out.txt || true)
            if grep -q "Windows Registry API Tests PASSED" /tmp/registry_test_out.txt; then
              echo "  ✓ registry_test: ${pass} passed, ${fail} failed"
            else
              echo "  ✗ registry_test: ${pass} passed, ${fail} failed"
            fi
          else
            echo "  (no output file found)"
          fi
          echo "================================================"
